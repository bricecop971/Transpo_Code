<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transpositeur IA - Final</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.2.2/abcjs-basic-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>

    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .upload-zone { 
            border: 2px dashed #00e5ff; padding: 40px; margin: 20px 0;
            background: rgba(0,229,255,0.05); cursor: pointer; border-radius: 10px;
        }
        
        #dashboard { display: none; background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        .dash-row { display: flex; gap: 10px; justify-content: space-between; margin-bottom: 15px; }
        .dash-card { flex: 1; background: #111; padding: 10px; border-radius: 5px; text-align: left; border: 1px solid #444; }
        .dash-card label { font-size: 11px; color: #888; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .dash-card input { width: 100%; background: transparent; border: none; color: #00e5ff; font-weight: bold; font-size: 16px; outline: none; }

        button { cursor: pointer; padding: 12px 24px; border-radius: 5px; border: none; font-weight: bold; font-size: 16px; margin: 5px; }
        .btn-primary { background: #00e5ff; color: black; }
        .btn-danger { background: #d32f2f; color: white; }
        
        /* IMPORTANT : Le papier doit √™tre blanc pour voir les notes */
        #paper { background: white; color: black; padding: 15px; border-radius: 5px; margin-top: 20px; overflow-x: auto; min-height: 150px; }
        #paper svg { width: 100%; }
        #paper svg path { fill: #000000 !important; }

        #debug-console { margin-top: 50px; background: #000; color: #ff5555; font-family: monospace; padding: 10px; text-align: left; font-size: 12px; display: none; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>üéº Transpositeur IA</h1>
        </header>

        <div class="upload-zone" onclick="document.getElementById('file-input').click()">
            <p id="upload-text">üìÇ Cliquez ici pour charger une partition</p>
            <input type="file" id="file-input" accept="image/*,.pdf" style="display:none;">
        </div>

        <div id="dashboard">
            <h3 style="margin-top:0; color:#aaa; font-size:14px;">DONN√âES D√âTECT√âES</h3>
            <div class="dash-row">
                <div class="dash-card"><label>Titre</label><input type="text" id="meta-title"></div>
                <div class="dash-card"><label>Mesure (M:)</label><input type="text" id="meta-meter"></div>
                <div class="dash-card"><label>Tonalit√© (K:)</label><input type="text" id="meta-key"></div>
            </div>

            <div style="border-top: 1px solid #444; padding-top: 15px;">
                <label style="color:#aaa; margin-right: 10px;">Transposer vers : </label>
                <select id="transposition" style="padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
                    <option value="Eb">Saxophone Alto (Eb)</option>
                    <option value="Bb">Trompette (Bb)</option>
                    <option value="F">Cor (F)</option>
                    <option value="C" selected>Piano / Fl√ªte (C)</option>
                </select>
                <button id="transpose-btn" class="btn-primary">G√©n√©rer la Partition</button>
            </div>
        </div>

        <div id="result-zone" style="display:none;">
            <h2 id="final-title">R√©sultat</h2>
            <div id="audio"></div>
            <div id="paper"></div>
            <button onclick="window.print()" style="background:#333; color:white;">üñ®Ô∏è Imprimer</button>
            <button onclick="window.location.reload()" class="btn-danger">Recommencer</button>
        </div>
    </div>

    <div id="debug-console"></div>

    <script>
        const debugBox = document.getElementById('debug-console');
        function logError(msg) {
            debugBox.style.display = 'block';
            debugBox.innerHTML += "üî¥ " + msg + "\n";
            console.error(msg);
        }

        const fileInput = document.getElementById('file-input');
        const uploadText = document.getElementById('upload-text');
        const dashboard = document.getElementById('dashboard');
        const resultZone = document.getElementById('result-zone');
        const metaTitle = document.getElementById('meta-title');
        const metaMeter = document.getElementById('meta-meter');
        const metaKey = document.getElementById('meta-key');
        const transposeBtn = document.getElementById('transpose-btn');

        let currentMusicData = null;

        // --- OUTILS ---
        function getBase64(file) {
            return new Promise((r, j) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => r(reader.result.split(',')[1]);
                reader.onerror = j;
            });
        }

        async function compressImage(file) {
            const bitmap = await createImageBitmap(file);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scale = Math.min(2000 / bitmap.width, 1);
            canvas.width = bitmap.width * scale;
            canvas.height = bitmap.height * scale;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
            return new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
        }

        async function convertPdfToImage(pdfFile) {
            const arrayBuffer = await pdfFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            return new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
        }

        // --- MOTEUR DE RECONSTRUCTION ABC (CORRIG√â) ---
        function buildAbc(data) {
            if (!data || !data.notes) return "";
            const attr = data.attributes || {};
            
            const T = metaTitle.value || "Partition IA";
            const M = metaMeter.value || attr.timeSignature || "4/4";
            const K = metaKey.value || attr.keySignature || "C";

            let abc = `X:1\nT:${T}\nM:${M}\nK:${K}\nL:1/4\n%%staffwidth 800\n`;

            // Calcul math√©matique des barres
            let [beats, val] = M.split('/').map(Number);
            if (!beats) { beats=4; val=4; }
            let measureMax = beats * (4/val); 
            let currentCount = 0;

            data.notes.forEach(n => {
                let noteStr = "";
                let dur = 1;

                // --- CORRECTION MAJEURE : GESTION DES SILENCES ---
                if (!n.pitch || n.pitch.toLowerCase() === "rest") {
                    noteStr = "z"; // Code ABC pour le silence
                } 
                else {
                    // Note normale
                    let p = n.pitch.toUpperCase().replace(/[0-9]/g, '');
                    let oct = parseInt(n.pitch.replace(/[^0-9]/g, '')) || 4;
                    
                    let char = p;
                    if (oct <= 3) char += ",";
                    if (oct === 5) char = char.toLowerCase();
                    if (oct >= 6) char = char.toLowerCase() + "'";

                    if (n.pitch.includes("#")) char = "^" + char.replace("#","");
                    if (n.pitch.includes("b")) char = "_" + char.replace("b","");
                    
                    noteStr = char;
                }

                // --- DUREE ---
                let type = (n.visualType || "quarter").toLowerCase();
                
                if (type.includes("whole")) { noteStr += "4"; dur = 4; }
                else if (type.includes("half")) { noteStr += "2"; dur = 2; }
                else if (type.includes("eighth")) { noteStr += "/2"; dur = 0.5; }
                else if (type.includes("sixteenth")) { noteStr += "/4"; dur = 0.25; }
                else { dur = 1; } 

                abc += noteStr + " ";
                
                // Barre auto
                currentCount += dur;
                if (currentCount >= measureMax - 0.01) {
                    abc += "| ";
                    currentCount = 0;
                }
            });

            abc += "|]";
            return abc;
        }

        // --- LOGIQUE ---
        fileInput.addEventListener('change', async function() {
            if (!fileInput.files.length) return;
            uploadText.innerHTML = "‚è≥ Analyse en cours... (Patientez)";
            
            try {
                let file = fileInput.files[0];
                let imgFile;
                if (file.type === 'application/pdf') {
                    imgFile = await convertPdfToImage(file);
                } else {
                    imgFile = await compressImage(file);
                }

                const base64 = await getBase64(imgFile);
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64, mimeType: 'image/jpeg' })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`Erreur API (${res.status})`);
                }

                const responseData = await res.json();
                if (responseData.error) throw new Error(responseData.error);

                currentMusicData = responseData.musicData;
                
                // Remplir Dashboard
                const attr = currentMusicData.attributes || {};
                metaTitle.value = "Partition Analys√©e";
                metaMeter.value = attr.timeSignature || "4/4";
                metaKey.value = attr.keySignature || "C";

                document.querySelector('.upload-zone').style.display = 'none';
                dashboard.style.display = 'block';
                
                // On force le clic pour afficher direct !
                setTimeout(() => transposeBtn.click(), 500);

            } catch (e) {
                uploadText.innerHTML = "‚ùå Erreur (voir logs)";
                logError(e.message);
            }
        });

        transposeBtn.addEventListener('click', function() {
            if (!currentMusicData) return;

            const keySelect = document.getElementById('transposition');
            const instName = keySelect.options[keySelect.selectedIndex].text;
            let visualTranspose = 0;
            if (keySelect.value === "Bb") visualTranspose = 2;
            if (keySelect.value === "Eb") visualTranspose = 9;
            if (keySelect.value === "F") visualTranspose = 7;

            const abcCode = buildAbc(currentMusicData);
            
            // DEBUG : Afficher le code g√©n√©r√© si besoin
            console.log("ABC CODE:", abcCode);

            document.getElementById('final-title').innerText = "R√©sultat : " + instName;
            resultZone.style.display = 'block';

            const visualObj = ABCJS.renderAbc("paper", abcCode, {
                responsive: "resize",
                visualTranspose: visualTranspose,
                add_classes: true
            });
            
            if (ABCJS.synth.supportsAudio()) {
                const synth = new ABCJS.synth.SynthController();
                synth.load("#audio", null, { displayLoop: true, displayPlay: true, displayProgress: true });
                const createSynth = new ABCJS.synth.CreateSynth();
                createSynth.init({ visualObj: visualObj[0] }).then(() => synth.setTune(visualObj[0], false));
            }
        });
    </script>
</body>
</html>
